Today's Report 

MySQL DCâ€“DR HA, Failover, Recovery & Restore

INITIAL SETUP (FOUNDATION)
create 2 folders 
dc and dr 
in both create data folders and my.cnf file

in my.cnf file (3306)
[mysqld]
basedir=C:/mysql/mysql-8.4.7-winx64
datadir=C:/mysql_lab/dc/data
port=3306
server-id=1

log-bin=mysql-bin
binlog-format=ROW
gtid-mode=ON
enforce-gtid-consistency=ON

read_only=OFF
super_read_only=OFF




in my.cnf (3307)
[mysqld]
basedir=C:/mysql/mysql-8.4.7-winx64
datadir=C:/mysql_lab/dr/data
port=3307
server-id=2

log-bin=mysql-bin
binlog-format=ROW
gtid-mode=ON
enforce-gtid-consistency=ON

read_only=ON
super_read_only=ON



initialize both the directories
cd /d C:\mysql\mysql-8.4.7-winx64\bin

mysqld.exe --defaults-file=C:\mysql_lab\dc\my.cnf --initialize-insecure
mysqld.exe --defaults-file=C:\mysql_lab\dr\my.cnf --initialize-insecure


then start both the servers
mysqld.exe --defaults-file=C:\mysql_lab\dc\my.cnf --console
mysqld.exe --defaults-file=C:\mysql_lab\dr\my.cnf --console


now come back to 3306 -> mysql -u root -P 3306

CREATE USER 'repl'@'%' IDENTIFIED BY 'innodb';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;

once password is setup then 
mysql -u root -P 3307

CHANGE REPLICATION SOURCE TO
  SOURCE_HOST='127.0.0.1',
  SOURCE_PORT=3306,
  SOURCE_USER='repl',
  SOURCE_PASSWORD='innodb',
  SOURCE_AUTO_POSITION=1,
  GET_SOURCE_PUBLIC_KEY=1;

START REPLICA;


SHOW REPLICA STATUS\G


verify by coming back to dc

CREATE DATABASE IF NOT EXISTS ha_test;
USE ha_test;

CREATE TABLE t (
  id INT AUTO_INCREMENT PRIMARY KEY,
  msg VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO t(msg) VALUES ('dc_write_ok');


view on dr
SELECT * FROM ha_test.t;




now once everything is setup we will move further for HA failover testing
stop 3306
come on root of 3307

STOP REPLICA;
RESET REPLICA ALL;
SET GLOBAL super_read_only=OFF;
SET GLOBAL read_only=OFF;

so now 3307 is primary and 3306 is closed

so dont directly start it, do one thing
add in my.cnf
super_read_only=ON
read_only=ON;
on dc my.cnf

now once read_only is on start again 3306 

now run on mysql 
STOP REPLICA;
RESET REPLICA;
CHANGE REPLICATION SOURCE TO
  SOURCE_HOST='127.0.0.1',
  SOURCE_PORT=3307,
  SOURCE_AUTO_POSITION=1;
START REPLICA;

so at this position 3306 is secondary and 3307 is primary if we want again  dc->dr
turn on super read and read only ON and then come back to 3306 and turn off from this position 
go back again to 3307 and 
stop replica
reset replica and again set 
CHANGE REPLICATION SOURCE TO
  SOURCE_HOST='127.0.0.1',
  SOURCE_PORT=3306,
  SOURCE_USER='repl',
  SOURCE_PASSWORD='innodb',
  SOURCE_AUTO_POSITION=1,
  GET_SOURCE_PUBLIC_KEY=1;

START REPLICA;


SHOW REPLICA STATUS\G
and again it will be back as dc as primary and dr as secondary

